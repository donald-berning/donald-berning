name: VIRP Build/scan; Deploy when environment approved
on:
  push:
    branches:
      - dhb800
jobs:
  Preamble:
    runs-on: windows-latest
    outputs:
      b: ${{ steps.zip.outputs.b }}
      DTB: ${{steps.zip.outputs.DTB}}  
    steps:
      - id: Zip
        run: |
          $b = ${{ github.run_number }} + 252  # bOffset
          echo "::set-output name=b::$b"
          $DT= (Get-Date).ToString('yyyyMMdd.HHmmss')
          echo "::set-output name=DTB::$DT"
          echo "Current $DT  RUN_NUMBER ${{ github.run_number }}  build number $b."

  Build:
    # if: false #skips the step (or job)
    needs: Preamble
    runs-on: windows-latest
    steps:
      - run: |
          echo "current = ${{(Get-Date).ToString('yyyyMMdd.HHmmss')}}"
          $DT= (Get-Date).ToString('yyyyMMdd.HHmmss')
          echo "current=$DT  DTB=${{needs.Preamble.outputs.DTB}}...    b=${{needs.Preamble.outputs.b}}..."
      - run: echo "-DestinationPath ""d:\Deployment Files\VIRP\Builds\DEV\${{needs.Preamble.outputs.DTB}}-${{needs.Preamble.outputs.b}}.deploy.zip"""
      - id: Zip
        # if: false #skips the step (or job)
        run: |
          Compress-Archive -Path c:\DeploymentFiles\VIRP\Builds\DEV\VIRP_SERVICE, c:\DeploymentFiles\VIRP\Builds\DEV\VIRP_WEB, 'c:\DeploymentFiles\VIRP\Builds\DEV\$$ReadMe' -DestinationPath "d:\Deployment Files\VIRP\Builds\DEV\${{needs.Preamble.outputs.DTB}}_${{needs.Preamble.outputs.b}}.deploy.zip"
      - run: echo "-DestinationPath ""d:\Deployment Files\VIRP\Builds\DEV\${{needs.Preamble.outputs.DTB}}-${{needs.Preamble.outputs.b}}.deploy.zip"""