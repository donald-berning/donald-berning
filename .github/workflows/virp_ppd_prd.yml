name: VIRP Build/scan; Deploy when environment approved
on:
  push:
    branches:
      - dhb800
jobs:
  Preamble:
    runs-on: windows-latest
    outputs:
      b: ${{ steps.zip.outputs.b }}
      DTB: ${{steps.zip.outputs.DTB}}  
    steps:
      - id: Zip
        run: |
          $b = ${{ github.run_number }} + 252  # bOffset
          echo "::set-output name=b::$b"
          $DT= (Get-Date).ToString('yyyyMMdd.HHmmss')
          echo "::set-output name=DTB::$DT"
          echo "Current $DT  RUN_NUMBER ${{ github.run_number }}  build number $b."
      - run: echo "current=$DT  DTB=${{needs.Preamble.outputs.DTB}}...    b=${{needs.Preamble.outputs.b}}..."
      - name: Set current date as env variable
        run: |
          $DT= (Get-Date).ToString('yyyyMMdd.HHmmss')
          echo "NOW::$DT" >> $GITHUB_ENV
      - name: Get current date
        id: date
        run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
      - name: Test with environment variables
        run: echo $TAG_NAME - $RELEASE_NAME
        env:
          TAG_NAME: nightly-tag-${{ steps.date.outputs.date }}
          RELEASE_NAME: nightly-release-${{ steps.date.outputs.date }}
      - name: Test with input
        uses: actions/hello-world-docker-action@master
        with:
          who-to-greet: Mona-the-Octocat-${{ steps.date.outputs.date }}
      - run: echo "steps.date.outputs.date = ${{ steps.date.outputs.date}}"

  Build:
    # if: false #skips the step (or job)
    needs: Preamble
    runs-on: windows-latest
    steps:
      - run: |
          $DT= (Get-Date).ToString('yyyyMMdd.HHmmss')
          echo "current=$DT  DTB=${{needs.Preamble.outputs.DTB}}...    b=${{needs.Preamble.outputs.b}}..."
      - run: echo "-DestinationPath ""d:\Deployment Files\VIRP\Builds\DEV\${{needs.Preamble.outputs.DTB}}-${{needs.Preamble.outputs.b}}.deploy.zip""" >> $GITHUB_STEP_SUMMARY
      - id: Zip
        if: false #skips the step (or job)
        run: |
          echo "Compress-Archive -Path c:\DeploymentFiles\VIRP\Builds\DEV\VIRP_SERVICE, c:\DeploymentFiles\VIRP\Builds\DEV\VIRP_WEB, 'c:\DeploymentFiles\VIRP\Builds\DEV\$$ReadMe' -DestinationPath ""d:\Deployment Files\VIRP\Builds\DEV\${{needs.Preamble.outputs.DTB}}_${{needs.Preamble.outputs.b}}.deploy.zip""" >> $GITHUB_STEP_SUMMARY
          Compress-Archive -Path c:\DeploymentFiles\VIRP\Builds\DEV\VIRP_SERVICE, c:\DeploymentFiles\VIRP\Builds\DEV\VIRP_WEB, 'c:\DeploymentFiles\VIRP\Builds\DEV\$$ReadMe' -DestinationPath "d:\Deployment Files\VIRP\Builds\DEV\${{needs.Preamble.outputs.DTB}}_${{needs.Preamble.outputs.b}}.deploy.zip"
      - run: echo "-DestinationPath ""d:\Deployment Files\VIRP\Builds\DEV\${{needs.Preamble.outputs.DTB}}-${{needs.Preamble.outputs.b}}.deploy.zip""" >> $GITHUB_STEP_SUMMARY
  Summary:
    needs: [Preamble, Build]
    runs-on: windows-latest
    steps:
      - run: echo $GITHUB_STEP_SUMMARY
      - run: |
          $DT= (Get-Date).ToString('yyyyMMdd.HHmmss')
          $DTB = ${{needs.Preamble.outputs.DTB}}
          echo "current=$DT  DTB=${{needs.Preamble.outputs.DTB}}...$DTB...    b=${{needs.Preamble.outputs.b}}..." >> $GITHUB_STEP_SUMMARY
          echo "current=$DT  DTB=${{needs.Preamble.outputs.DTB}}...$DTB...    b=${{needs.Preamble.outputs.b}}..."
          $DTE = $DT - $DTB
          echo "elapsed = $DTE"
          $DTE = ($DTE).ToString('yyyyMMdd.HHmmss')
          echo "elapsed = $DTE"
